---
title: "RNA-Seq Analysis Report"
output: 
  html_document:
    toc: true
    toc_depth: 4
---

<style type="text/css">
    div.datatables { height: auto !important;}
</style>


```{r setup, include=FALSE}
library(knitr)
library(reshape2)
library(ggplot2)
library(data.table)
library(DT)
library(RCurl)
library(htmltools)

knitr::opts_chunk$set(echo = TRUE)

addLinkTag<-function(text,link) {
  result<-paste0("<a href='",link,"' target='_blank'>",text,"</a>")
  return(result)
}
  
figRef <- local({
    tag <- numeric()
    created <- logical()
    used <- logical()
    function(label, caption, prefix = options("figcap.prefix"), 
        sep = options("figcap.sep"), prefix.highlight = options("figcap.prefix.highlight")) {
        i <- which(names(tag) == label)
        if (length(i) == 0) {
            i <- length(tag) + 1
            tag <<- c(tag, i)
            names(tag)[length(tag)] <<- label
            used <<- c(used, FALSE)
            names(used)[length(used)] <<- label
            created <<- c(created, FALSE)
            names(created)[length(created)] <<- label
        }
        if (!missing(caption)) {
            created[label] <<- TRUE
            paste0(prefix.highlight, prefix, " ", i, sep, prefix.highlight, 
                " ", caption)
        } else {
            used[label] <<- TRUE
            paste(prefix, tag[label])
        }
    }
})
options(figcap.prefix = "Figure", figcap.sep = ":", figcap.prefix.highlight = "**")

tabRef <- local({
    tag <- numeric()
    created <- logical()
    used <- logical()
    function(label, caption, prefix = options("tabcap.prefix"), 
        sep = options("tabcap.sep"), prefix.highlight = options("tabcap.prefix.highlight")) {
        i <- which(names(tag) == label)
        if (length(i) == 0) {
            i <- length(tag) + 1
            tag <<- c(tag, i)
            names(tag)[length(tag)] <<- label
            used <<- c(used, FALSE)
            names(used)[length(used)] <<- label
            created <<- c(created, FALSE)
            names(created)[length(created)] <<- label
        }
        if (!missing(caption)) {
            created[label] <<- TRUE
            paste0(prefix.highlight, prefix, " ", i, sep, prefix.highlight, 
                " ", caption)
        } else {
            used[label] <<- TRUE
            paste(prefix, tag[label])
        }
    }
})
options(tabcap.prefix = "Table", tabcap.sep = ":", tabcap.prefix.highlight = "**")

files<-read.table("fileList1.txt", header=FALSE, as.is=TRUE)
rownames(files)<-files$V2

rnaseqOptions<-read.table("fileList2.txt", header=FALSE, as.is=TRUE)
rownames(rnaseqOptions)<-rnaseqOptions$V2

summary<-paste0("###1. Summary\nThis report includes quality check for raw sequencing data (section 2), reads mapping and assignment (section 3), and expression similarity between samples (section 4). The results of differential expression analysis are summarized in section 5 using the criteria of fold change >= ", rnaseqOptions["DE_fold_change", 1], " and FDR <= ", rnaseqOptions["DE_pvalue", 1], ".")

hasEnrichmentAnalysis<-any(grepl("enrichment_", rownames(files)))
#hasEnrichmentAnalysis<-0

summaryFile<-"RNASeq_Summary.Rmd"
enrichFile<-"RNASeq_EnrichmentAnalysis.Rmd"
struFile<-"RNASeq_Structure.Rmd"

if(hasEnrichmentAnalysis){
  summary<-paste0(summary, "The top five enriched elements of each category are reported in section 6.")
}
cat(summary, file=summaryFile)

if(hasEnrichmentAnalysis){
  cat("###6. Funcional enrichment analysis\nList of the top five significantly enriched elements\n<br>\n", file=enrichFile)
}
structureIndex<-ifelse(hasEnrichmentAnalysis, 7, 6)
structure = paste0("###", structureIndex, ". Results folder structure\n")
cat(structure, file=struFile)
```

<br>

```{r structure, child=summaryFile} 
```

<br>

###2. Sequencing Quality

####2.1 Summary of sequencing quality

```{r,echo=FALSE,results='asis', fig.align="center", fig.cap=figRef("fastqc_per_base_sequence_quality", "The mean quality scores of sequencing reads in each position")}
include_graphics(files["fastqc_per_base_sequence_quality",1])
```

<br>
<br>

```{r,echo=FALSE,results='asis', fig.align="center", fig.cap=figRef("fastqc_per_sequence_gc_content", "The average GC content of sequencing reads")}
include_graphics(files["fastqc_per_sequence_gc_content",1])
```

<br>
<br>

```{r,echo=FALSE,results='asis', fig.align="center", fig.cap=figRef("fastqc_adapter_content", "Adapter content of sequencing reads")}
if(file.exists(files["fastqc_adapter_content",1])){
  include_graphics(files["fastqc_adapter_content",1])
}
```

<br>
<br>

### 3. Mapping quality
#### 3.1 Summary of mapping quality
```{r,echo=FALSE,results='asis', fig.align="center", fig.cap=figRef("STAR_summary", "The statistics of RNAseq mapping results")}
include_graphics(files["STAR_summary",1])
```

<br>
<br>

```{r echo=FALSE,results='asis'}
table<-read.csv(files["STAR_summary_table",1])
output_table1<-data.frame(table[,c(2,3,4,5)], (table[,3]+table[,4])/table[,2], row.names=table[,1])
colnames(output_table1)<-c("Input reads", "Uniquely mapped reads", "Mapped to multiple loci", "Mapped to too many loci", "Ratio")
print(kable(output_table1, caption=tabRef("mapSummary", "The summary of RNAseq mapping results")))
```

**Ratio** = (Uniquely mapped + Mapped to multiple loci)/ Input reads

<br>
<br>

### 4. Expression Quantification
#### 4.1 Summary of reads assignment
```{r,echo=FALSE,results='asis', fig.align="center", fig.cap=figRef("gene_reads", "The number of reads assigned to genes in uniquely mapped reads")}
table<- read.table(files["featureCounts_table",1], header=TRUE)
output_table2<-data.frame(table[,c(1, 2, 9, 12)])
colnames(output_table2)<- c("Sample", "Unassigned ambiguity", "Assigned", "Unassigned no features")
meltreads=melt(output_table2, id="Sample", variable.name="Read", value.name="Count")
print(ggplot(meltreads, aes(x=Sample, y=Count, fill=Read)) + 
  geom_bar(stat="identity", width=0.5) +
  theme(axis.text.x = element_text(angle=90, vjust=0.5, size=11, hjust=0, face="bold"),
        axis.text.y = element_text(size=11, face="bold")))
```

<br>
<br>

```{r echo=FALSE,results='asis'}
output_table2$UniquelyMapped<-apply(output_table2[,c(2,3,4)], 1, sum)
output_table2$PercentAssigned<-apply(output_table2[,c(3,5)], 1, function(x){x[1] * 100 / x[2]})
colnames(output_table2)<- c("Sample", "Unassigned ambiguity", "Assigned", "Unassigned no features", "Total uniquely mapped", "Percent assigned")
output_table2<- output_table2[,c(1,3,6,2,4,5)]
print(kable(output_table2, caption=tabRef("geneSummary", "The summary of reads assignment to genes")))
```

<br>
<br>

####4.2 Expression density of samples
```{r,echo=FALSE,results='asis', fig.align="center", fig.cap=figRef("correlation_density", "Expression density distribution of each sample")}
include_graphics(files["correlation_density",1])
```

<br>
<br>

####4.3 Similarity between samples
```{r,echo=FALSE,results='asis', fig.align="center", fig.cap=figRef("correlation_heatmap", "Heatmap of expression similarity across samples")}
include_graphics(files["correlation_heatmap",1])
```

<br>
<br>

```{r,echo=FALSE,results='asis', fig.align="center", fig.cap=figRef("correlation_PCA", "PCA plot of samples")}
include_graphics(files["correlation_PCA",1])
```

<br>
<br>

```{r,echo=FALSE,results='asis', fig.align="center", fig.cap=figRef("correlation_cluster", "Correlation cluster of samples")}
include_graphics(files["correlation_cluster",1])
```

<br>
<br>

###5. Differential expression
####5.1 Volcano plot
```{r,echo=FALSE,results='asis', fig.align="center", fig.cap=figRef("Volcano_plot", "Volcano plot for all comparisons")}
include_graphics(files["deseq2_volcano_plot",1])
```

<br>
<br>

####5.2 Summary of differential analysis
```{r echo=FALSE,results='asis'}
DESeq2_files<-files[grep("DESeq2_sig", files[,1]),]
DESeq2_list<-list()
for (i in 1:nrow(DESeq2_files)){
  DESeq2_list[[i]]<-read.csv(DESeq2_files[i,1], header=TRUE)
}
output_table3<-data.frame(c(gsub("_DESeq2_sig.csv","",basename(DESeq2_files[,1]))), c(unlist(lapply(DESeq2_list, nrow))))
colnames(output_table3)<-c("Comparison", "Number of DEGs")
print(kable(output_table3, caption= tabRef("deseq2_table", paste0("DEG numbers under FC > ", rnaseqOptions["DE_fold_change", 1], " & FDR < ", rnaseqOptions["DE_pvalue", 1]))))

for (i in 1:nrow(DESeq2_files)){
  comparisonName<-DESeq2_files[i,2]
  deseq2<-read.csv(DESeq2_files[i,1], header=TRUE, row.names=1)
  if(nrow(deseq2) > 0){
    maxrow<-min(nrow(deseq2), 10)
    cnames<-c("baseMean", "log2FoldChange","lfcSE", "stat", "pvalue", "padj", "FoldChange")
    if("Feature_gene_name"%in%colnames(deseq2)){
      cnames<-c("Feature_gene_name", cnames)
    }
    deseq2table<-deseq2[c(1:maxrow), cnames]
    print(kable(deseq2table, row.names=1, caption= tabRef(comparisonName, paste0(comparisonName, " top ", maxrow, " differential expressed genes"))))
  }
}
```

<br>
<br>

```{r enrich, child = if (hasEnrichmentAnalysis) enrichFile} 
```

<br>

```{r echo=FALSE, results='asis'}
if(hasEnrichmentAnalysis){
  enrich_files<-files[grepl("enrichment_", rownames(files)),]
  for (i in 1:nrow(enrich_files)){
    fdata<-fread(enrich_files[i,1], select=c(1,2,5,9), nrows=5, data.table=FALSE, col.names=c("ID", "Name", "#Gene", "FDR"))
    ename<-rownames(enrich_files)[i]
    print(kable(fdata, caption=tabRef(ename, ename)))
  }  

  processGesaTable<-function(gseaTableFile,maxCategoryFdr=0.05,maxCategory=5,absLinkPath=FALSE) {
        rawTable<-read.delim(gseaTableFile,header=T,as.is=T)
        rawTableOut<-NULL
        for (i in head(which(rawTable$FDR.q.val<=maxCategoryFdr),maxCategory)) {
                categoryName=rawTable[i,1]
                gseaUrl=paste0("http://software.broadinstitute.org/gsea/msigdb/cards/",categoryName)
                categoryNameInTable<-addLinkTag(text=categoryName,link=gseaUrl)

                gseaWeb<-getURL(gseaUrl)
                temp<-strsplit(gseaWeb,"description|\\<td\\>")[[1]]
                j=grep("Brief",temp)
                categoryDescription<-gsub("^>","",temp[j+2])
                categoryDescription<-gsub("<\\/$","",categoryDescription)

                rawTableOut<-rbind(rawTableOut,unlist(c(categoryNameInTable,categoryDescription,rawTable[i,c(4,5,6,8)])))
        }
        colnames(rawTableOut)[1:2]<-c("Name","Description")
        return(rawTableOut)
  }
  
  gsea_files<-files[grepl("gsea_", rownames(files)),]
  out<-list()
  for (i in 1:nrow(gsea_files)){
    gfolders<-read.csv(gsea_files[i,1],header=T,stringsAsFactor=F)
    gname<-gsub(".rnk.*", "", basename(gsea_files[i,1]))
    for (j in 1:nrow(gfolders)){
      resultDirSub<-gfolders$Folder[j]
      
      posTableFile<-list.files(resultDirSub,pattern="gsea_report_for_na_pos_\\d+\\.xls$",full.names=TRUE)
      if (length(posTableFile)!=1) {
        warning(paste0("Can't find positive-regulated GSEA table file in ", resultDirSub))
      }else{
        rawTableOut<-processGesaTable(posTableFile)
        ename<-paste0(gname, " ", gfolders$GseaCategory[j], " Positive-regulated")
        print(kable(rawTableOut, caption=tabRef(ename, ename)))
      }
      
      negTableFile<-list.files(resultDirSub,pattern="gsea_report_for_na_neg_\\d+\\.xls$",full.names=TRUE)
      if (length(negTableFile)!=1) {
        warning(paste0("Can't find negative-regulated GSEA table file in ", resultDirSub))
      }else{
        rawTableOut<-processGesaTable(negTableFile)
        ename<-paste0(gname, " ", gfolders$GseaCategory[j], " Negative-regulated")
        print(kable(rawTableOut, caption=tabRef(ename, ename)))
      }
    }
  }  
}
``` 

<br>

```{r structure, child=struFile} 
```

```{r structure_link, echo=FALSE, results='asis'}
df<-NULL
fpkmFile<-list.files('.',pattern="fpkm.tsv$",full.names=TRUE,recursive=TRUE)
if(length(fpkmFile) > 0){
  df<-rbind(df, data.frame(File=addLinkTag(fpkmFile, fpkmFile), Description="Gene expression abundance table"))
}

deseqAll<-list.files('.',pattern="_DESeq2.csv$",full.names=TRUE,recursive=TRUE)
if(length(deseqAll) > 0){
  df<-rbind(df, data.frame(File=addLinkTag(deseqAll, deseqAll), Description="Differential expression analysis table"))
}

deseqSig<-list.files('.',pattern="_DESeq2_sig.csv$",full.names=TRUE,recursive=TRUE)
if(length(deseqSig) > 0){
  df<-rbind(df, data.frame(File=addLinkTag(deseqSig, deseqSig), Description="Significantly differential expressed genes"))
}

print(kable(df, caption=tabRef("resultFiles", "Result files")))

```

```{r teardown, include=FALSE}
if(file.exists(summaryFile)){
  file.remove(summaryFile)
}
if(file.exists(enrichFile)){
  file.remove(enrichFile)
}
if(file.exists(struFile)){
  file.remove(struFile)
}
```
